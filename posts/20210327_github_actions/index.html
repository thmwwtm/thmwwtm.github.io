<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Github actions from zero to this blog - The hungarian man who went to Malta</title><meta name=keywords content="development,software,github,tech,CI/CD,automation"><meta name=description content="I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ I got to a working pipeline in 25 tries, lets go through each step how it improved piece by piece.
I started to work on it at night, thinking it would not take long. (hehe, famous last words). After around 20 failed runs, I went to sleep."><meta name=author content="Me"><link rel=canonical href=https://thmwwtm.github.io/posts/20210327_github_actions/><link href=https://thmwwtm.github.io/assets/css/stylesheet.min.e855f825213afc7aacdf334a190f4ccef15ec9f889837b681633bd7ab2d3f3d8.css integrity="sha256-6FX4JSE6/Hqs3zNKGQ9MzvFeyfiJg3toFjO9erLT89g=" rel="preload stylesheet" as=style><link rel=icon href=https://thmwwtm.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://thmwwtm.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://thmwwtm.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://thmwwtm.github.io/apple-touch-icon.png><link rel=mask-icon href=https://thmwwtm.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.109.0"><link rel=stylesheet href=/css/cookie.css><script type=application/javascript>var dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,GA_SESSION_STORAGE_KEY,doNotTrack=dnt=="1"||dnt=="yes";doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,window.sessionStorage&&(GA_SESSION_STORAGE_KEY="ga:clientId",ga("create","UA-184738555-1",{storage:"none",clientId:sessionStorage.getItem(GA_SESSION_STORAGE_KEY)}),ga(function(e){sessionStorage.setItem(GA_SESSION_STORAGE_KEY,e.get("clientId"))})),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="Github actions from zero to this blog"><meta property="og:description" content="I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ I got to a working pipeline in 25 tries, lets go through each step how it improved piece by piece.
I started to work on it at night, thinking it would not take long. (hehe, famous last words). After around 20 failed runs, I went to sleep."><meta property="og:type" content="article"><meta property="og:url" content="https://thmwwtm.github.io/posts/20210327_github_actions/"><meta property="article:published_time" content="2021-03-27T09:02:00+02:00"><meta property="article:modified_time" content="2021-03-27T09:02:00+02:00"><meta property="og:site_name" content="The hungarian man who went to Malta"><meta name=twitter:card content="summary"><meta name=twitter:title content="Github actions from zero to this blog"><meta name=twitter:description content="I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ I got to a working pipeline in 25 tries, lets go through each step how it improved piece by piece.
I started to work on it at night, thinking it would not take long. (hehe, famous last words). After around 20 failed runs, I went to sleep."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Github actions from zero to this blog","name":"Github actions from zero to this blog","description":"I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ I got to a working pipeline in ‚Ä¶","keywords":["development","software","github","tech","CI/CD","automation"],"articleBody":"I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ I got to a working pipeline in 25 tries, lets go through each step how it improved piece by piece.\nI started to work on it at night, thinking it would not take long. (hehe, famous last words). After around 20 failed runs, I went to sleep. As soon as I got into vertical, I had the moment of clarity what a noob tunnel vision I had. The next morning I fixed it in the remaining 5 attempts where I added new steps and fixed typos, so not major fuckups like in the previous twenty. Take away again: don‚Äôt force it, rest well.\nHistory First, we need to know why we are starting from where. If you are interested only in github actions dos and donts, you can skip this history paragraph. When I first set up the GitHub pages with hugo I wanted to keep it simple, I followed the recommendation in the guide on the gohugo page. This means a simple manual deployment, the public (build output) folder is set up as a git submodule and the submodule is pushed directly to the GH pages repo. Easy,\nwrite the post or make modifications update config with secrets hugo #builds the site cd public \u0026\u0026 git commit[...] \u0026\u0026 git push #updating GH page cd .. \u0026\u0026 git commit[...] \u0026\u0026 git push #updating sources and save the reference to GH pages I even had a small sh script doing this, was far enough.\nThe plan Moving to Github actions I wanted to replicate the same steps. I saw some prepared Github actions in the marketplace, also found complete workflow in my used theme‚Äôs repository. As we will see, the problem is that none of the already existing actions are for the same setup that I have. For example, GH page can be a separate repo or branch.\nCreate the workflow Github actions calls the pipeline as workflow, the file where you define it goes to the folder .github/workflows as a something.yml file. I created it right on the web, it has nice UI, with the marketplace of the actions on the side. But you need to copy the snippet from the marketplace to your file, as it can be put into a lot of places and with a lot of variations regarding configuration. The simple starter template is useful, helpful to see the basic properties you should work with, but some of what I needed later was missing. Yep, you could say RTFM, I am not whining just telling my exact case.\nThe example has the actions/checkout@v2 as the first step, then some no brainer sh script and that‚Äôs it. The gohugo workflows I saw and most of the workflows at all starts with the checkout not a big surprise. This action gets the current repo into the pipeline machine to work with. This is a crucial part, details below.\nI replaced the rest with the hugo related steps. The web editor was not nice to me, I was not able to scroll to the end of the file, maybe it is a Linux/Firefox issue. So I Ctrl+A, Ctlrl+C it to a text editor, added the changes, copied it back to the web editor. The preview tab worked fine.\nThe example had the\n# Allows you to run this workflow manually from the Actions tab workflow_dispatch: lines what was perfect, I wanted to run it manually to test the steps.\nSo I did, and it failed. Would have been a surprise if not.\nFeedback for Github too, but mainly info for you to keep an eye on. The view workflow page on Github is not refreshing automatically. So when you click start workflow you need to refresh the page to see the newly started run. I was tricked at least once and clicked start multiple times making the workflow run in parallel with itself.\nDebug It is quite easy while quite hidden at the same time, to get some more information out of your workflow runs, here you see how to enable debug logs\nactions/checkout@v2 This is basically the center of everything. Does things in the background what is really nice to do simple stuff easily, but makes it tricky if you leave the main path. Yes, again RTFM.\nIf you give no extra properties it will clone the repo the workflow is running from and sets up a secret GITHUB_TOKEN for the same repo. This is a protected secret name, you won‚Äôt be able to create a secret with this name. It is used automatically by this action. If you need to work with multiple repositories in a workflow the token above won‚Äôt work as that is only for the current repo. You will need to create a Personal Access Token and tell the action to use this not the default one by\nwith: token: ${{ secrets.YOUR_PAT_SECRETNAME }} providing it in the with field‚Äôs token property. In the with you have a lot of other things you can specify like a different repo, ssh, submodule, etc.\nSince it is Github, I thought the git operations will be the easiest thing in the whole pipeline, but until I figured out the GITHUB_TOKEN behavior and changed it to PAT, it was a bit of a struggling. It felt like it can work only with one repo and blocked the possibility of pulling or pushing the submodule changes.\nConfigure git (At least these errors are visible in the normal output and straight forward)\nOut of the box the git you get, gonna git get boom boom pow is not configured at all, it will fail as no author, name, email is given.\ngit config --global user.name github-actions[bot] git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com You want to add these lines into your script before commit to make it pass, and also to have the github-action name and icon next to the commit in the history.\nPulling a repo could also fail with no merge preference is configured. I added ‚Äîff-only at the end of git pull, but it can be set up in git config too.\nDetour of git actions Most of the existing actions use the GITHUB_TOKEN so searching for a ‚Äúgit push action‚Äù and finding out that won‚Äôt work for the same reasons was strengthening my incorrect perception of how git commands work here. I tried ad-m/git-push-action, turned out it is just not for what I want. I had a look into peaceiris/actions-gh-pages@v3, just won‚Äôt work for me either.\nMoment of clarity Still a bit lead by the idea of one job one repo, I decided to separate the one job example into multiple jobs. Actually, without the wrong cause, it is the right way to do it, and how I did pipelines before. ü§¶\nbuild and separate the output take the output and put it where it will run Having the publish step as just a git push was maybe a bit deceiving too.\nArtifacts For that, there are two friends actions/upload-artifact and actions/download-artifact. In one job you store your build output with upload, then you get the same thing with download in a later job. The upload will make the artifacts available to check on the web interface until its retention period ends and gets deleted.\nNeedy boi To chain jobs together you specify the needs property with the name of the job you want to run before this one. If it is not set your artifacts may not be ready to download after the upload when the job is started.\nvs Why did it fail few more times As originally the public folder was set up as a submodule, it contained a .git folder. So without preparation, up-, then downloading the artifacts contained the .git folder, and the target where I wanted to put it had one too, of course github actions don‚Äôt want to override that, so I added an extra step, preparing the artifact before upload, I removed the .git folder, uploading only the good stuff.\nIn this preparation step, I also copy the last commit message to a file, so when downloading the build output and committing to the other repo, I can add the same commit message there.\nFirst I named the upload publish and pointed to the public folder, then at the download I gave the name ‚Äúpublish‚Äù to download. It failed as could not find it. I searched a bit and found multiple issues in the actions repo regarding naming, the common solution was, give name and path the same string value and it will work. Another solution was in another thread, to change to actions/upload-artifact@v1 from @v2, I did both, and it is working. May need further investigation what was the real issue.\nYou see above how to access secrets. You can pass them as parameters or env vars into your step.\n- name: suchstep with: myinput: ${{ secrets.VERY_SECRET }} env: myvar: ${{ secrets.MUCH_CONFIDENTAL }} And get them with dollar and curly braces, AND as a property of the secrets object. Once I forgot to add the secrets prefix, could happen to anyone üôÑ\nGreed It seemed I figured out everything, got greedy, and added one more step, to update the source repo‚Äôs submodule with the published commit. I had to fabricate a commit message, and I used the wrong type of quotes, single instead of double. Worked well with echo but not outside that, sloppy test.\nIt reached the last step, failed, I fixed, run again, and it fails one step earlier. Why? Because the middle job is a commit and push, and as it was working before, now we have nothing to commit, working tree clean, and this is taken as a non-zero return value. üò† I had to add temporarily a continue-on-error: true to this job, or useless change to the repo, in order to test out the last step too.\nSummary Get the badge for your workflow: It took me 4-6 hours maybe to go from zero to a quite satisfying pipeline, with two repositories working together. Maybe there is an emulator or simulator already, or other ways to debug a workflow, please lighten me up if you know, I did no research on that, however, this trial and error way of progress is not the most efficient I guess. Running it is not that time-consuming takes around 10 seconds in this case. The time between runs (khm.., RTFM) is longer.\nAt the end the workflow is:\nwhen there is a push or PR updating the content folder run (manual start still available) checkout the source repo update submodules (theme and public folder) setup gohugo on the runner generate the output with hugo (build) prepare artifacts (remove .git from public folder, save commit msg to file) upload artifacts checkout the GH pages repo (public submodule in source repo) download the artifacts (will overwrite files here) commit and push to the GH pages repo checkout the source repo again go to the public folder pull the updated GH page repo go to the root folder commit and push the updated submodule reference to the source repo You may figure out if you read carefully these 15 steps are separated into 3 jobs.\nbuild (1 to 7) publish (8 to 10) post-publish (11 to end) All in all, about Github actions, the possibilities are good, most of the use cases are covered, most of the documentation, examples are good (hence the RTFMs in this post), the sources are there to check if you miss something from the docs.\nI liked working with it and I really like the result. Now I just push an .md file and I see it on my blog in few seconds, all repos updated nicely.\nNext stop is creating my own github-action, probably it will be this workflow packaged into one action. You see, this is, as most of them are, just some shell commands after each other, put into a container or npm package.\nI am curious what will I think about this sentence after I actually do it. üòÑ\n","wordCount":"2036","inLanguage":"en","datePublished":"2021-03-27T09:02:00+02:00","dateModified":"2021-03-27T09:02:00+02:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://thmwwtm.github.io/posts/20210327_github_actions/"},"publisher":{"@type":"Organization","name":"The hungarian man who went to Malta","logo":{"@type":"ImageObject","url":"https://thmwwtm.github.io/favicon.ico"}}}</script></head><body class=single id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://thmwwtm.github.io/ accesskey=h>Thmwwtm</a>
<span class=logo-switches><span class=theme-toggle><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Github actions from zero to this blog</h1><div class=post-meta>March 27, 2021&nbsp;¬∑&nbsp;10 min&nbsp;¬∑&nbsp;Me</div></header><div class=toc><details><summary><div class=details accesskey=c>Table of Contents</div></summary><blockquote><ul><li><a href=#history aria-label=History>History</a></li><li><a href=#the-plan aria-label="The plan">The plan</a></li><li><a href=#create-the-workflow aria-label="Create the workflow">Create the workflow</a></li><li><a href=#debug aria-label=Debug>Debug</a></li><li><a href=#actionscheckoutv2 aria-label=actions/checkout@v2>actions/checkout@v2</a><ul><li><a href=#configure-git aria-label="Configure git">Configure git</a></li><li><a href=#detour-of-git-actions aria-label="Detour of git actions">Detour of git actions</a></li></ul></li><li><a href=#moment-of-clarity aria-label="Moment of clarity">Moment of clarity</a></li><li><a href=#artifacts aria-label=Artifacts>Artifacts</a><ul><li><a href=#needy-boi aria-label="Needy boi">Needy boi</a></li></ul></li><li><a href=#why-did-it-fail-few-more-times aria-label="Why did it fail few more times">Why did it fail few more times</a><ul><li><a href=#greed aria-label=Greed>Greed</a></li></ul></li><li><a href=#summary aria-label=Summary>Summary</a></li></ul></blockquote></details></div><div class=post-content><p>I wanted to try Github actions since it got announced. Finally I had it on my foreseeable list when I started this blog, and lately, I did it. üëè üéâüéÜ
I got to a working pipeline in 25 tries, lets go through each step how it improved piece by piece.</p><blockquote><p>I started to work on it at night, thinking it would not take long. (hehe, famous last words). After around 20 failed runs, I went to sleep. As soon as I got into vertical, I had the moment of clarity what a noob tunnel vision I had. The next morning I fixed it in the remaining 5 attempts where I added new steps and fixed typos, so not major fuckups like in the previous twenty. Take away again: don&rsquo;t force it, rest well.</p></blockquote><h2 id=history>History<a hidden class=anchor aria-hidden=true href=#history>#</a></h2><p>First, we need to know why we are starting from where. If you are interested only in github actions dos and donts, you can skip this history paragraph.
When I first set up the GitHub pages with hugo I wanted to keep it simple, I followed the recommendation in the guide on the gohugo page. This means a simple manual deployment, the public (build output) folder is set up as a git submodule and the submodule is pushed directly to the GH pages repo. Easy,</p><ol><li>write the post or make modifications</li><li>update config with secrets</li><li><code>hugo</code> #builds the site</li><li><code>cd public && git commit[...] && git push</code> #updating GH page</li><li><code>cd .. && git commit[...] && git push</code> #updating sources and save the reference to GH pages</li></ol><p>I even had a small <code>sh</code> script doing this, was far enough.</p><h2 id=the-plan>The plan<a hidden class=anchor aria-hidden=true href=#the-plan>#</a></h2><p>Moving to Github actions I wanted to replicate the same steps. I saw some prepared Github actions in the marketplace, also found complete workflow in my used theme&rsquo;s repository.
As we will see, the problem is that none of the already existing actions are for the same setup that I have.
For example, GH page can be a separate repo or branch.</p><h2 id=create-the-workflow>Create the workflow<a hidden class=anchor aria-hidden=true href=#create-the-workflow>#</a></h2><p>Github actions calls the pipeline as <code>workflow</code>, the file where you define it goes to the folder <code>.github/workflows</code> as a <code>something.yml</code> file. I created it right on the web, it has nice UI, with the marketplace of the actions on the side. But you need to copy the snippet from the marketplace to your file, as it can be put into a lot of places and with a lot of variations regarding configuration.
The simple starter template is useful, helpful to see the basic properties you should work with, but some of what I needed later was missing. Yep, you could say RTFM, I am not whining just telling my exact case.</p><p>The example has the <code>actions/checkout@v2</code> as the first step, then some no brainer <code>sh</code> script and that&rsquo;s it. The <code>gohugo</code> workflows I saw and most of the workflows at all starts with the checkout not a big surprise. This action gets the current repo into the pipeline machine to work with. This is a crucial part, details below.</p><p>I replaced the rest with the hugo related steps. The web editor was not nice to me, I was not able to scroll to the end of the file, maybe it is a Linux/Firefox issue. So I <code>Ctrl+A, Ctlrl+C</code> it to a text editor, added the changes, copied it back to the web editor. The preview tab worked fine.</p><p>The example had the</p><pre tabindex=0><code>    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:
</code></pre><p>lines what was perfect, I wanted to run it manually to test the steps.</p><p>So I did, and it failed. Would have been a surprise if not.</p><p>Feedback for Github too, but mainly info for you to keep an eye on.
The view workflow page on Github is not refreshing automatically. So when you click start workflow you need to refresh the page to see the newly started run. I was tricked at least once and clicked start multiple times making the workflow run in parallel with itself.</p><h2 id=debug>Debug<a hidden class=anchor aria-hidden=true href=#debug>#</a></h2><p>It is quite easy while quite hidden at the same time, to get some more information out of your workflow runs, <a href=https://docs.github.com/en/actions/managing-workflow-runs/enabling-debug-logging#enabling-step-debug-logging>here you see how to enable debug logs</a></p><h2 id=actionscheckoutv2>actions/checkout@v2<a hidden class=anchor aria-hidden=true href=#actionscheckoutv2>#</a></h2><p>This is basically the center of everything. Does things in the background what is really nice to do simple stuff easily, but makes it tricky if you leave the main path. Yes, again RTFM.</p><p>If you give no extra properties it will clone the repo the workflow is running from and sets up a secret <code>GITHUB_TOKEN</code> for the same repo. This is a protected secret name, you won&rsquo;t be able to create a secret with this name. It is used automatically by this action.
If you need to work with multiple repositories in a workflow the token above won&rsquo;t work as that is only for the current repo. You will need to create a <a href=https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token><strong>P</strong>ersonal <strong>A</strong>ccess <strong>T</strong>oken</a> and tell the action to use this not the default one by</p><pre tabindex=0><code>with:
    token: ${{ secrets.YOUR_PAT_SECRETNAME }}
</code></pre><p>providing it in the <code>with</code> field&rsquo;s <code>token</code> property.
In the with you have a lot of other things you can specify like a different repo, ssh, submodule, etc.</p><p>Since it is Github, I thought the git operations will be the easiest thing in the whole pipeline, but until I figured out the <code>GITHUB_TOKEN</code> behavior and changed it to <code>PAT</code>, it was a bit of a struggling. It felt like it can work only with one repo and blocked the possibility of pulling or pushing the submodule changes.</p><h3 id=configure-git>Configure git<a hidden class=anchor aria-hidden=true href=#configure-git>#</a></h3><p>(At least these errors are visible in the normal output and straight forward)</p><p>Out of the box the git you get, <del>gonna git get boom boom pow</del> is not configured at all, it will fail as <em>no author, name, email is given</em>.</p><pre tabindex=0><code>git config --global user.name github-actions[bot]
git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
</code></pre><p>You want to add these lines into your script before commit to make it pass, and also to have the github-action name and icon next to the commit in the history.</p><p><img src=/images/20210321_github_actions/github_action_bot.png alt="github-actions bot"></p><p>Pulling a repo could also fail with no merge preference is configured. I added <code>‚Äîff-only</code> at the end of <code>git pull</code>, but it can be set up in git config too.</p><h3 id=detour-of-git-actions>Detour of git actions<a hidden class=anchor aria-hidden=true href=#detour-of-git-actions>#</a></h3><p>Most of the existing actions use the GITHUB_TOKEN so searching for a &ldquo;git push action&rdquo; and finding out that won&rsquo;t work for the same reasons was strengthening my incorrect perception of how git commands work here. I tried <a href=https://github.com/ad-m/github-push-action><code>ad-m/git-push-action</code></a>, turned out it is just not for what I want. I had a look into <a href=https://github.com/peaceiris/actions-gh-pages><code>peaceiris/actions-gh-pages@v3</code></a>, just won&rsquo;t work for me either.</p><h2 id=moment-of-clarity>Moment of clarity<a hidden class=anchor aria-hidden=true href=#moment-of-clarity>#</a></h2><p>Still a bit lead by the idea of one job one repo, I decided to separate the one job example into multiple jobs.
Actually, without the wrong cause, it is the right way to do it, and how I did pipelines before. ü§¶</p><ol><li>build and separate the output</li><li>take the output and put it where it will run</li></ol><p>Having the publish step as just a git push was maybe a bit deceiving too.</p><h2 id=artifacts>Artifacts<a hidden class=anchor aria-hidden=true href=#artifacts>#</a></h2><p>For that, there are two friends <a href=https://github.com/marketplace/actions/upload-a-build-artifact><code>actions/upload-artifact</code></a> and <a href=https://github.com/marketplace/actions/download-a-build-artifact><code>actions/download-artifact</code></a>. In one job you store your build output with upload, then you get the same thing with download in a later job.
The upload will make the artifacts available to check on the web interface until its retention period ends and gets deleted.</p><h3 id=needy-boi>Needy boi<a hidden class=anchor aria-hidden=true href=#needy-boi>#</a></h3><p>To chain jobs together you specify the <code>needs</code> property with the name of the job you want to run before this one. If it is not set your artifacts may not be ready to download after the upload when the job is started.</p><p><img src=/images/20210321_github_actions/github_action_noneed.png alt=NoNeed>
vs
<img src=/images/20210321_github_actions/github_action_needs.png alt=Needs></p><h2 id=why-did-it-fail-few-more-times>Why did it fail few more times<a hidden class=anchor aria-hidden=true href=#why-did-it-fail-few-more-times>#</a></h2><p>As originally the <code>public</code> folder was set up as a submodule, it contained a <code>.git</code> folder. So without preparation, up-, then downloading the artifacts contained the .git folder, and the target where I wanted to put it had one too, of course github actions don&rsquo;t want to override that, so I added an extra step, preparing the artifact before upload, I removed the .git folder, uploading only the good stuff.</p><blockquote><p>In this preparation step, I also copy the last commit message to a file, so when downloading the build output and committing to the other repo, I can add the same commit message there.</p></blockquote><p>First I named the upload <code>publish</code> and pointed to the <code>public</code> folder, then at the download I gave the <code>name</code> &ldquo;publish&rdquo; to download. It failed as could not find it. I searched a bit and found multiple issues in the actions repo regarding naming, the common solution was, give <code>name</code> and <code>path</code> the same string value and it will work.
Another solution was in another thread, to change to <code>actions/upload-artifact@v1</code> from <code>@v2</code>, I did both, and it is working. May need further investigation what was the real issue.</p><p>You see above how to access <code>secrets</code>. You can pass them as parameters or <code>env</code> vars into your step.</p><pre tabindex=0><code>- name: suchstep
    with: 
        myinput: ${{ secrets.VERY_SECRET }}
    env:
        myvar: ${{ secrets.MUCH_CONFIDENTAL }}
</code></pre><p>And get them with dollar and curly braces, AND as a property of the <code>secrets</code> object. Once I forgot to add the secrets prefix, could happen to anyone üôÑ</p><h3 id=greed>Greed<a hidden class=anchor aria-hidden=true href=#greed>#</a></h3><p>It seemed I figured out everything, got greedy, and added one more step, to update the source repo&rsquo;s submodule with the published commit. I had to fabricate a commit message, and I used the wrong type of quotes, single instead of double. Worked well with echo but not outside that, sloppy test.</p><p>It reached the last step, failed, I fixed, run again, and it fails one step earlier. Why? Because the middle job is a commit and push, and as it was working before, now we have nothing to commit, working tree clean, and this is taken as a non-zero return value. üò†
I had to add temporarily a <code>continue-on-error: true</code> to this job, or useless change to the repo, in order to test out the last step too.</p><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p><a href=https://github.com/thmwwtm/thmwwtm-gohugo/actions/workflows/main.yml><img src=https://github.com/thmwwtm/thmwwtm-gohugo/actions/workflows/main.yml/badge.svg alt="Publish to GH pages"></a></p><p>Get the badge for your workflow:
<img src=/images/20210321_github_actions/github_action_badge.png alt="Get the badge for your workflow"></p><p>It took me 4-6 hours maybe to go from zero to a quite satisfying pipeline, with two repositories working together.
Maybe there is an emulator or simulator already, or other ways to debug a workflow, please lighten me up if you know, I did no research on that, however, this trial and error way of progress is not the most efficient I guess.
Running it is not that time-consuming takes around 10 seconds in this case. The time between runs (khm.., RTFM) is longer.</p><p>At the end the workflow is:</p><ol><li>when there is a push or PR updating the content folder run (manual start still available)</li><li>checkout the source repo</li><li>update submodules (theme and public folder)</li><li>setup gohugo on the runner</li><li>generate the output with hugo (build)</li><li>prepare artifacts (remove .git from public folder, save commit msg to file)</li><li>upload artifacts</li><li>checkout the GH pages repo (public submodule in source repo)</li><li>download the artifacts (will overwrite files here)</li><li>commit and push to the GH pages repo</li><li>checkout the source repo again</li><li>go to the public folder</li><li>pull the updated GH page repo</li><li>go to the root folder</li><li>commit and push the updated submodule reference to the source repo</li></ol><p>You may figure out if you read carefully these 15 steps are separated into 3 jobs.</p><ol><li>build (1 to 7)</li><li>publish (8 to 10)</li><li>post-publish (11 to end)</li></ol><p>All in all, about Github actions, the possibilities are good, most of the use cases are covered, most of the documentation, examples are good (hence the RTFMs in this post), the sources are there to check if you miss something from the docs.</p><p>I liked working with it and I really like the result. Now I just push an <code>.md</code> file and I see it on my blog in few seconds, all repos updated nicely.</p><p>Next stop is creating my own github-action, probably it will be this workflow packaged into one action.
You see, this is, as most of them are, just some shell commands after each other, put into a container or npm package.</p><p>I am curious what will I think about this sentence after I actually do it. üòÑ</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://thmwwtm.github.io/tags/development>development</a></li><li><a href=https://thmwwtm.github.io/tags/software>software</a></li><li><a href=https://thmwwtm.github.io/tags/github>github</a></li><li><a href=https://thmwwtm.github.io/tags/tech>tech</a></li><li><a href=https://thmwwtm.github.io/tags/ci/cd>CI/CD</a></li><li><a href=https://thmwwtm.github.io/tags/automation>automation</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://thmwwtm.github.io/>The hungarian man who went to Malta</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top" accesskey=g><button class=top-link id=top-link type=button><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a><div class=cookie-container><p>No cookies, however Google Analytics is used on this website to know what is happening, but only if you are not against it.</p><button class=cookie-btn>
Okay</button></div><script src=/js/cookie.js></script>
<script defer src=https://thmwwtm.github.io/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"})})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>